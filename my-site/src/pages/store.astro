---
// src/pages/store.astro
import Layout from '../layouts/Layout.astro';
import StoreLayout from '../components/StoreLayout';
import Footer from '../components/Footer.astro';
import { getCollection } from 'astro:content';
import type { Product } from '../data/productsdata';

// Content Collectionから商品データを取得
const productEntries = await getCollection('products');

// Product型に変換（シリアライズ可能な形式）
const products: Product[] = productEntries.map((entry) => ({
  id: entry.id,
  name: entry.data.name,
  price: entry.data.price,
  type: entry.data.type,
  platform: entry.data.platform,
  paid: entry.data.paid,
  bundle: entry.data.bundle,
  image: entry.data.image,
  gumroadUrl: entry.data.gumroadUrl,
  date: entry.data.date,
  demoUrl: entry.data.demoUrl,
}));

// 画像の最適化処理
const productImages = import.meta.glob<{ default: ImageMetadata }>('../assets/img/*.png');
const imagesMap = new Map<string, string>();

for (const product of products) {
  const imagePath = `../assets/img/${product.image}`;
  
  try {
    if (productImages[imagePath]) {
      const image = await productImages[imagePath]();
      const { getImage } = await import('astro:assets');
      const optimizedImage = await getImage({ 
        src: image.default,
        width: 600,
        format: 'webp'
      });
      imagesMap.set(product.id, optimizedImage.src);
    } else {
      console.warn(`Image not found for product: ${product.id} at ${imagePath}`);
      const placeholderUrl = `https://placehold.co/800x800/6366f1/ffffff?text=${encodeURIComponent(product.id)}`;
      imagesMap.set(product.id, placeholderUrl);
    }
  } catch (error) {
    console.error(`Error loading image for product: ${product.id}`, error);
    const placeholderUrl = `https://placehold.co/800x800/6366f1/ffffff?text=${encodeURIComponent(product.id)}`;
    imagesMap.set(product.id, placeholderUrl);
  }
}

const imageMap: Record<string, string> = Object.fromEntries(imagesMap);

console.log('Products loaded:', products.length);
console.log('Images loaded:', Object.keys(imageMap).length);
---

<Layout title="Store-kimura taro" isStorePage={true}>
  <StoreLayout client:load products={products} imageMap={imageMap} />
  
  <!-- Footerをサイドバーの右側に配置 -->
  <div class="lg:ml-56">
    <Footer />
  </div>
</Layout>