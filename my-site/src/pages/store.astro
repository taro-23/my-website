---
// src/pages/store.astro
import Layout from '../layouts/Layout.astro';
import StoreLayout from '../components/StoreLayout';
import Footer from '../components/Footer.astro';
import { getCollection, type CollectionEntry } from 'astro:content';

// Content Collectionから商品データを取得
const productEntries = await getCollection('products');

// products.tsと同じ形式に変換
const products = productEntries.map((entry: CollectionEntry<'products'>) => ({
  id: entry.id,
  ...entry.data
}));

const productImages = import.meta.glob<{ default: ImageMetadata }>('../assets/img/*.png');
const imagesMap = new Map();

for (const product of products) {
  const imagePath = `../assets/img/${product.image}`;
  
  try {
    if (productImages[imagePath]) {
      const image = await productImages[imagePath]();
      const { getImage } = await import('astro:assets');
      const optimizedImage = await getImage({ 
        src: image.default,
        width: 600,
        format: 'webp'
      });
      imagesMap.set(product.id, optimizedImage.src);
    } else {
      const placeholderUrl = `https://placehold.co/800x800/6366f1/ffffff?text=${encodeURIComponent(product.id)}`;
      imagesMap.set(product.id, placeholderUrl);
    }
  } catch (error) {
    const placeholderUrl = `https://placehold.co/800x800/6366f1/ffffff?text=${encodeURIComponent(product.id)}`;
    imagesMap.set(product.id, placeholderUrl);
  }
}

const imageMap = Object.fromEntries(imagesMap);
---

<Layout title="Store - Music Store" isStorePage={true}>
  <StoreLayout client:load products={products} imageMap={imageMap} />
  
  <!-- Footerをサイドバーの右側に配置 -->
  <div class="lg:ml-56">
    <Footer />
  </div>
</Layout>