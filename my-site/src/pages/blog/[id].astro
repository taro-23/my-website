---
// src/pages/blog/[id].astro
import Layout from '../../layouts/Layout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';
import { Image } from 'astro:assets';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const blogImages = import.meta.glob<{ default: ImageMetadata }>('../../assets/img/blog/*.{png,jpg,jpeg}');
  
  const paths = await Promise.all(
    posts.map(async (post: CollectionEntry<'blog'>) => {
      const imagePath = `../../assets/img/blog/${post.data.image}`;
      let imageModule = null;
      
      if (blogImages[imagePath]) {
        imageModule = await blogImages[imagePath]();
      }
      
      return {
        params: { id: post.id },
        props: { 
          post,
          imageModule: imageModule?.default || null
        },
      };
    })
  );
  
  return paths;
}

type Props = {
  post: CollectionEntry<'blog'>;
  imageModule: ImageMetadata | null;
};

const { post, imageModule } = Astro.props;
const { Content } = await post.render();

// 関連記事を取得
const allPosts = await getCollection('blog');
const relatedPosts = allPosts
  .filter((p: CollectionEntry<'blog'>) => 
    p.id !== post.id && 
    p.data.tags.some((tag: string) => post.data.tags.includes(tag))
  )
  .slice(0, 3);

const relatedPostImages = import.meta.glob<{ default: ImageMetadata }>('../../assets/img/blog/*.{png,jpg,jpeg}');
const relatedImagesMap = new Map<string, ImageMetadata>();

for (const rp of relatedPosts) {
  const imagePath = `../../assets/img/blog/${rp.data.image}`;
  if (relatedPostImages[imagePath]) {
    const img = await relatedPostImages[imagePath]();
    relatedImagesMap.set(rp.id, img.default);
  }
}

const formatDate = (dateStr: string) => {
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};
---

<Layout title={`${post.data.title} - Blog`}>
  <div class="bg-white min-h-screen">
    <!-- パンくずリスト -->
    <div class="border-b border-gray-900">
      <nav class="container mx-auto px-4 py-4 text-sm text-gray-700">
        <a href="/" class="hover:text-gray-900 transition">Home</a>
        <span class="mx-2">/</span>
        <a href="/blog" class="hover:text-gray-900 transition">Blog</a>
        <span class="mx-2">/</span>
        <span class="text-gray-900 font-medium">{post.data.title}</span>
      </nav>
    </div>

    <article class="container mx-auto px-4 py-12 max-w-4xl">
      <!-- ヘッダー情報 -->
      <div class="mb-8">
        <div class="flex flex-wrap gap-2 mb-4">
          {post.data.tags.map((tag: string) => (
            <span class="text-xs bg-gray-900 text-white px-3 py-1 rounded uppercase tracking-wide">
              {tag}
            </span>
          ))}
        </div>
        
        <h1 class="text-4xl md:text-5xl font-bold mb-6 leading-tight">
          {post.data.title}
        </h1>
        
        <div class="flex items-center gap-4 text-sm text-gray-600 pb-6 border-b border-gray-300">
          <span class="font-medium">{post.data.author}</span>
          <span>•</span>
          <time datetime={post.data.publishDate}>
            {formatDate(post.data.publishDate)}
          </time>
        </div>
      </div>

      <!-- アイキャッチ画像 -->
      {imageModule && (
        <div class="mb-12 border-2 border-gray-900 overflow-hidden">
          <Image
            src={imageModule}
            alt={post.data.title}
            width={1200}
            height={675}
            format="webp"
            class="w-full h-auto"
          />
        </div>
      )}

      <!-- 記事本文 -->
      <div class="prose prose-lg max-w-none mb-12">
        <Content />
      </div>

      <!-- 戻るボタン -->
      <div class="mt-12 pt-12 border-t border-gray-300">
        <a 
          href="/blog" 
          class="inline-flex items-center gap-2 text-gray-900 hover:text-gray-600 font-bold uppercase tracking-wide text-sm transition-colors"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
          Back to Blog
        </a>
      </div>
    </article>

    <!-- 関連記事 -->
    {relatedPosts.length > 0 && (
      <div class="bg-gray-50 border-t-2 border-gray-900">
        <div class="container mx-auto px-4 py-16 max-w-6xl">
          <h2 class="text-3xl font-bold mb-8 uppercase tracking-wide">Related Posts</h2>
          <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
            {relatedPosts.map((rp: CollectionEntry<'blog'>) => (
              <a 
                href={`/blog/${rp.id}`}
                class="bg-white border-2 border-gray-900 overflow-hidden hover:bg-gray-50 transition-colors"
              >
                <div class="aspect-video bg-gray-200 overflow-hidden">
                  {relatedImagesMap.has(rp.id) ? (
                    <Image
                      src={relatedImagesMap.get(rp.id)!}
                      alt={rp.data.title}
                      width={600}
                      height={338}
                      format="webp"
                      class="w-full h-full object-cover"
                    />
                  ) : (
                    <div class="w-full h-full flex items-center justify-center text-gray-400">
                      <span class="text-sm">No Image</span>
                    </div>
                  )}
                </div>
                <div class="p-6">
                  <h3 class="font-bold text-lg mb-2 line-clamp-2">{rp.data.title}</h3>
                  <p class="text-gray-600 text-sm line-clamp-2">{rp.data.description}</p>
                </div>
              </a>
            ))}
          </div>
        </div>
      </div>
    )}
  </div>
</Layout>