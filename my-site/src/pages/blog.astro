---
// src/pages/blog.astro
import Layout from '../layouts/Layout.astro';
import BlogLayout from '../components/BlogLayout';
import Footer from '../components/Footer.astro';
import { getCollection } from 'astro:content';

// ブログ記事を取得
const blogEntries = await getCollection('blog');

// シリアライズ可能な形式に変換
// .mdx拡張子を削除したスラッグを使用
const posts = blogEntries.map((entry) => ({
  id: entry.slug || entry.id.replace(/\.mdx?$/, ''),
  title: entry.data.title,
  description: entry.data.description,
  publishDate: entry.data.publishDate,
  tags: entry.data.tags,
  image: entry.data.image,
  author: entry.data.author,
}));

// 画像の最適化処理
const blogImages = import.meta.glob<{ default: ImageMetadata }>('../assets/img/blog/*.{png,jpg,jpeg}');
const imagesMap = new Map<string, string>();

for (const post of posts) {
  // 元のエントリーから画像パスを取得
  const originalEntry = blogEntries.find(e => 
    (e.slug || e.id.replace(/\.mdx?$/, '')) === post.id
  );
  
  if (originalEntry) {
    const imagePath = `../assets/img/blog/${originalEntry.data.image}`;
    
    try {
      if (blogImages[imagePath]) {
        const image = await blogImages[imagePath]();
        const { getImage } = await import('astro:assets');
        const optimizedImage = await getImage({ 
          src: image.default,
          width: 800,
          format: 'webp'
        });
        imagesMap.set(post.id, optimizedImage.src);
      } else {
        console.warn(`Image not found for post: ${post.id} at ${imagePath}`);
        const placeholderUrl = `https://placehold.co/800x450/111827/ffffff?text=${encodeURIComponent(post.title)}`;
        imagesMap.set(post.id, placeholderUrl);
      }
    } catch (error) {
      console.error(`Error loading image for post: ${post.id}`, error);
      const placeholderUrl = `https://placehold.co/800x450/111827/ffffff?text=${encodeURIComponent(post.title)}`;
      imagesMap.set(post.id, placeholderUrl);
    }
  }
}

const imageMap: Record<string, string> = Object.fromEntries(imagesMap);

// SEO用のメタデータ
const seoTitle = "News & Blog - Updates and Insights | kimura taro";
const seoDescription = "Updates on new releases, sound design notes, and music production tips. News about sample packs, wavetables, and synth patches.";
---

<Layout 
  title={seoTitle}
  description={seoDescription}
  isStorePage={true}
>
  <BlogLayout client:load posts={posts} imageMap={imageMap} />
  
  <!-- Footerをサイドバーの右側に配置 -->
  <div class="lg:ml-56">
    <Footer />
  </div>
</Layout>